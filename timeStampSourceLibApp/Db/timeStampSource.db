record(longin, "$(DEV):TSS_EVENTCODE")
{
    field(DESC, "Event Code for port $(PORT)")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) EventCode")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(FLNK, "$(DEV):TSS_EVENTCODE_HST")
}

record(longin, "$(DEV):TSS_APULSEID")
{
    field(DESC, "Pulse ID for Active Timeslot")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) ActivePulseID")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(FLNK, "$(DEV):TSS_APULSEID_HST")
}

record(longin, "$(DEV):TSS_CPULSEID")
{
    field(DESC, "Pulse ID for Current Timeslot")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) CurrentPulseID")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(FLNK, "$(DEV):TSS_CPULSEID_HST")
}

record(longin, "$(DEV):TSS_DPULSEID")
{
    field(DESC, "Pulse ID difference")
    field(DTYP, "TimeStampSource")
    field(INP, "@$(PORT) DiffPulseID")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(FLNK, "$(DEV):TSS_DPULSEID_HST")
}

record(longin, "$(DEV):TSS_CTIMESLOT")
{
    field(DESC, "Current timeslot")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) CurrentTimeSlot")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(FLNK, "$(DEV):TSS_CTIMESLOT_HST")
}

record(longin, "$(DEV):TSS_ERTICKS")
{
    field(DESC, "EVR Clock Tick counter at callback time")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) ErTicks")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(FLNK, "$(DEV):TSS_ERTICKS_HST")
}

record(longout, "$(DEV):TSS_SETEC")
{
    field(DESC, "Set Event Code for port $(PORT)")
    field(DTYP, "TimeStampSource")
    field(OUT,  "@$(PORT) EventCode")
    field(VAL,  "$(EVNTC=0)")
    field(FLNK, "$(DEV):TSS_SETEC_PUSH")
}

record(seq, "$(DEV):TSS_SETEC_PUSH")
{
    field(DOL1,  "$(DEV):TSS_SETEC")
    field(LNK1,  "$(DEV):TSS_START.EVNT")
}

#
# This detects when the camera acquisition starts
# and causes the PulseIDs to be saved in the pipeline
#record(seq, "$(DEV):TSS_ACQ_PUSH")
#{
#    field(DOL1,  "$(DEV):Acquire PP")
#    field(LNK1,  "$(DEV):TSS_IMAGE_ACQ")
#}
# The above did not work, this is currently done by the EnableCB PV (OUTD field),
# which is declared in the profile.template, in the axisTickApp/Db directory
#
# TODO: change this scheme, find a better way to trigger the TSS_IMAGE_ACQUISITION
# processing. This is required to start saving PULSEIDs to later tag the images
#

record(sub, "$(DEV):TSS_IMAGE_ACQUISITION") 
{
    field(DESC, "Start/Stop PULSEID logging")
    field(INAM, "")
    field(SCAN, "Passive")
    field(SNAM, "tssImageAcquisition")
    field(INPA, "$(DEV):Acquire.VAL")
#    field(INPA, "$(DEV):Acquisition.VAL")
}

record(sub, "$(DEV):TSS_IMAGE_ACQUSITION_RESET")
{
    field(DESC, "Reset perfMeasure counters")
    field(INAM, "")
    field(SNAM, "tssImageAcquisitionReset")
}

record(sub, "$(DEV):TSS_START")
{
    field(DESC, "Records timestamp of TSS_SETEC event")
    field(INAM, "tssStartInit")
    field(SNAM, "tssStart")
    field(SCAN, "Event")
    field(EVNT, "140") # 120 Hz
    field(PRIO,  "HIGH")
    field(INPA, "$(DEV):TSS_START.EVNT")
    field(PREC, "1")
    field(TSE, "-1")
#    field(DISV, "0")
}

record(sub, "$(DEV):TSS_RESTART")
{
    field(DESC, "Re-enables event 140 to re-sync camera")
    field(INAM, "")
    field(SNAM, "tssRestart")
    field(SCAN, "Event")
    field(EVNT, "141") # 60 Hz
    field(PREC, "1")
    field(TSE, "-1")
}

record(longout, "$(DEV):TSS_IMAGE_FIDUCIAL")
{
    field(DESC, "Number of fiducials between images")
    field(DTYP, "TimeStampSource")
    field(OUT,  "@$(PORT) ImageFiducials")
    field(VAL,  "3")
}

record(longin, "$(DEV):TSS_INVALID_PULSEID_COUNT")
{
    field(DESC, "Count number of invalid PULSEIDS")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) PulseIdInvalidCount")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
}

record(longin, "$(DEV):TSS_ELAPSED")
{
    field(DESC, "Current acquisition elapsed time")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) ElapsedTime")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(EGU, "us")
}

record(longin, "$(DEV):TSS_ELAPSED_MIN")
{
    field(DESC, "Min acquisition elapsed time")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) ElapsedTimeMin")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(EGU, "us")
}

record(calc, "$(DEV):TSS_EXPECTED_TRANSMISSION_TIME")
{
    field(DESC, "Expected transmission time")
    field(INPA, "$(DEV):SizeX_RBV")
    field(INPB, "$(DEV):SizeY_RBV")
    field(INPC, "2000000000") # Link speed (2Gbps)
    field(CALC, "(A*B*2*8/C)*1000*1000")
    field(EGU, "us")
    field(SCAN, "2 second")
    field(PINI, "YES")
}

record(longin, "$(DEV):TSS_ELAPSED_MAX")
{
    field(DESC, "Max acquisition elapsed time")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) ElapsedTimeMax")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(EGU, "us")
}

record(longin, "$(DEV):TSS_IMAGE_LOST_COUNT")
{
    field(DESC, "Count number of images lost")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) ImageLostCount")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
}

record(longin, "$(DEV):TSS_BUFFER_COUNT")
{
    field(DESC, "Number of images pending")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) BufferCount")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(HHSV, "MAJOR")
    field(HIHI, "2")
}

record(longin, "$(DEV):TSS_RESYNC_COUNT")
{
    field(DESC, "Count FIFO resyncs")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) ResyncCount")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
}

record(longin, "$(DEV):TSS_PULSEID_LOST")
{
    field(DESC, "Latest PULSEID lost")
    field(DTYP, "TimeStampSource")
    field(INP,  "@$(PORT) PulseIdLost")
    field(SCAN, "I/O Intr")
    field(PRIO, "LOW")
    field(TSE, "-2")
    field(MDEL, "-1")
    field(FLNK, "$(DEV):TSS_PULSEID_LOST_HST")
}

record(compress, "$(DEV):TSS_PULSEID_LOST_HST")
{
    field(DESC, "History buffer for lost PULSEIDs")
    field(INP,  "$(DEV):TSS_PULSEID_LOST")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(NSAM=256)")
    field(TSEL, "$(DEV):TSS_PULSEID_LOST.TIME")
}

record(compress, "$(DEV):TSS_EVENTCODE_HST")
{
    field(DESC, "History buffer for event code")
    field(INP,  "$(DEV):TSS_EVENTCODE")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(NSAM=256)")
    field(TSEL, "$(DEV):TSS_EVENTCODE.TIME")
}

record(compress, "$(DEV):TSS_APULSEID_HST")
{
    field(DESC, "History buffer for active pulse ID")
    field(INP,  "$(DEV):TSS_APULSEID")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(NSAM=256)")
    field(TSEL, "$(DEV):TSS_APULSEID.TIME")
}

record(compress, "$(DEV):TSS_CPULSEID_HST")
{
    field(DESC, "History buffer for current pulse ID")
    field(INP,  "$(DEV):TSS_CPULSEID")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(NSAM=256)")
    field(TSEL, "$(DEV):TSS_CPULSEID.TIME")
}

record(compress, "$(DEV):TSS_DPULSEID_HST")
{
    field(DESC, "History buffer for pulse ID difference")
    field(INP,  "$(DEV):TSS_DPULSEID")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(NSAM=256)")
    field(TSEL, "$(DEV):TSS_DPULSEID.TIME")
}
 
record(compress, "$(DEV):TSS_CTIMESLOT_HST")
{
    field(DESC, "History buffer for current timeslot")
    field(INP,  "$(DEV):TSS_CTIMESLOT")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(NSAM=256)")
    field(TSEL, "$(DEV):TSS_CTIMESLOT.TIME")
}

record(compress, "$(DEV):TSS_ERTICKS_HST")
{
    field(DESC, "History buffer for evr tick counter")
    field(INP,  "$(DEV):TSS_ERTICKS")
    field(ALG,  "Circular Buffer")
    field(NSAM, "$(NSAM=256)")
    field(TSEL, "$(DEV):TSS_ERTICKS.TIME")
}
